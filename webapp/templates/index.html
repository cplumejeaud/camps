<!DOCTYPE html>
    <html lang="{{ lang }}">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ _('title') }}</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
        <style>
            * { margin:0; padding:0; box-sizing:border-box; }
            body {font-family:'Segoe UI',sans-serif; background:linear-gradient(135deg,#667eea,#764ba2); min-height:100vh; padding:20px;}
            .container {max-width:1800px; margin:auto; background:white; border-radius:20px; box-shadow:0 20px 60px rgba(0,0,0,0.3); overflow:hidden;}
            .header {background:linear-gradient(135deg,#2d3748,#1a202c); color:white; padding:40px; text-align:center;}
            .header h1 {font-size:2.5em; margin-bottom:10px;}
            .content {display:grid; grid-template-columns:33.33% 66.67%; gap:30px; padding:40px;}
            .section {background:#f8f9fa; border-radius:15px; padding:15px; box-shadow:0 4px 15px rgba(0,0,0,0.08);}
            .section h2 {color:#2d3748; font-size:24px; margin-bottom:20px; display:flex; align-items:center; gap:10px;}
            .section h2::before {content:''; width:4px; height:24px; background:linear-gradient(#667eea,#764ba2); border-radius:2px;}
            .radar-section {grid-column:1; grid-row:1;}
            .button-section {grid-column:2; grid-row:2; display:flex; flex-direction:column; gap:20px;}
            .map-section {grid-column:2; grid-row:1; overflow: hidden;}
            #map {height:100%; min-height:500px; border-radius:10px;}
            #radarChart {height:420px; width:100%;}
            #radarChart2 {height:420px; width:100%;}
            .btn-add, .btn-about, .btn-clear {padding:18px; background:linear-gradient(135deg,#1f77b4,#125b86); color:white; border-radius:12px;
                      text-align:center; text-decoration:none; font-weight:600; font-size:18px; box-shadow:0 4px 15px rgba(31,119,180,0.3); cursor:pointer;}
            .btn-clear {background:linear-gradient(135deg,#dc2626,#991b1b);}
            .btn-add:hover, .btn-about:hover, .btn-clear:hover {transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.4);}
            .camp-info {background:#e3f2fd; padding:15px; border-radius:8px; margin-bottom:15px; border-left:4px solid #1f77b4;}
            .modal {display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5);}
            .modal-content {background-color:white; margin:15% auto; padding:20px; border-radius:10px; width:80%; max-width:500px; position:relative;}
            .close {color:#aaa; float:right; font-size:28px; font-weight:bold; cursor:pointer;}
            .close:hover {color:black;}
            @media (max-width:1200px){
                .content {grid-template-columns:1fr;}
                .radar-section{grid-row:2;} .button-section{grid-row:3;} .map-section{grid-row:1;}
            }
            /* Onglets des 2 radars */ 
            .tab-container { margin-bottom: 20px; }
            .tab-btn { background: #e2e8f0; border: none; padding: 10px 24px; cursor: pointer; font-weight:600; border-radius:8px 8px 0 0; margin-right:2px;}
            .tab-btn.active { background: #667eea; color: white; }
            .tab-content { display: none; }
            .tab-content.active { display: block; }
            /* Onglets graphiques / about */
            .tab-content2 { display: none; }
            .tab-content2.active { display:grid; grid-template-columns:33.33% 66.67%; gap:30px; padding:40px; }
            .tab-content3 { display: none; }
            .tab-content3.active { display:grid; grid-template-columns: 100% ; gap:30px; padding:40px; }
            .tab-btn2 { background: #e2e8f0; border: none; padding: 10px 24px; cursor: pointer; font-weight:600; border-radius:8px 8px 0 0; margin-right:2px;}
            .tab-btn2.active { background: #764ba2; color: white; }
            .pinfo {font-size: 14px;}
            .tabbed { list-style: none; counter-reset: item; padding-left: 0; } 
            .tabbed li { counter-increment: item; margin-left: 2em; /* indentation du texte */ position: relative; } 
            .tabbed li::before { content: counter(item) "."; position: absolute; left: -2em; /* crée l'effet "tabulation" */ width: 1.5em; /* espace réservé pour le numéro */ text-align: right; }

        </style>
    </head>
    <body>
        {% if info_message %}
        <div style="background:#e0f7fa;color:#006064;padding:12px 20px;border-radius:8px;
                    margin:20px auto 0 auto;max-width:700px;text-align:center;font-size:1.1em;">
            {{ info_message }}
        </div>
        {% endif %}
        <div class="container">
            <div class="header">
                <h1>{{ _('title') }}</h1>
                <p>{{ _('subtitle') }}</p>
            </div>
            <div class="tab-container">
                <button class="tab-btn2 active" onclick="showTabGeneral('tab1_graphics')">{{ _('main') }}</button>
                <button class="tab-btn2" onclick="showTabGeneral('aboutModal')">{{ _('about') }}</button>
            </div>

            <div class="tab-content2 active" id="tab1_graphics" >
                <div class="section radar-section">
                    <h2>{{ _('radar_title') }}</h2>
                    <div class="camp-info" id="campInfo" style="display:none;">
                        <h3 id="campName"></h3>
                        <p id="campDetails"></p>
                    </div>
                    <div class="tab-container">
                        <button class="tab-btn active" onclick="showTab('tab1')">{{ _('dist_profile') }}</button>
                        <button class="tab-btn" onclick="showTab('tab2')">{{ _('note_profile') }}</button>
                    </div>
                    <div id="tab1" class="tab-content active">
                        <div id="radarChart">{{ radar_html|safe }}</div>
                        <div style="text-align:center; margin-top:15px;">
                            <button class="btn-clear" onclick="clearAllIndividualCamps()">{{ _('clear_radar') }}</button>
                        </div>
                    </div>
                    <div id="tab2" class="tab-content">
                        <div id="radarChart2">{{ radar2_html|safe }}</div>
                        <div style="text-align:center; margin-top:15px;">
                            <button class="btn-clear" onclick="clearAllIndividualCamps()">{{ _('clear_radar') }}</button>
                        </div>
                    </div>
                </div>

                <div class="section button-section">
                    <h2>{{ _('actions') }}</h2>
                    <a class="btn-add" href="{{ url_for('create_camp') }}">{{ _('add_camp') }}</a>
                    <!-- <button class="btn-about" onclick="showAboutModal()">{{ _('about') }}</button> -->
                </div>

                <div class="section map-section">
                    <h2>{{ _('map_title') }}</h2>
                    <div id="map">{{ map_html|safe }} </div> 
                </div>
            </div>

            <!-- Modal À propos class="modal" -->
            <div class="tab-content3" id="aboutModal">
                <div class="section" style="grid-column:1; grid-row:1; overflow: hidden;"><!--class="modal-content"-->
                    <!-- <span class="close" onclick="closeAboutModal()">&times;</span> -->
                    <h2>{{ _('about_objectif_title') }}</h2>
                    <p class="pinfo">{{ _('about_objectif_text')|safe }}</p>
                </div>
                <div class="section" style="grid-column:1; grid-row:2; overflow: hidden;">
                    <h2>{{ _('about_voc_title') }}</h2>
                    <p class="pinfo">{{ _('about_voc_text')|safe }}</p>
                </div>
                <div class="section" style="grid-column:1; grid-row:3; overflow: hidden;">
                    <h2>{{ _('about_howto_title') }}</h2>
                    <p class="pinfo">{{ _('about_howto_text')|safe }}</p>
                    <p class="pinfo">{{ _('about_howto_text2')|safe }}</p>
                </div>
                <div class="section" style="grid-column:1; grid-row:4; overflow: hidden;">
                    <h2>{{ _('about_source_title') }}</h2>
                    <p class="pinfo">{{ _('about_source_text')|safe }}</p>
                </div>                
                <div class="section" style="grid-column:1; grid-row:5; overflow: hidden;">
                    <h2>{{ _('about_credit_title') }}</h2>
                    <p class="pinfo">{{ _('about_credit_text')|safe }}</p>
                    <p class="pinfo">{{ _('about_credit_text2')|safe }}</p>
                </div>
            </div>
        </div>

        <script>
            //Fonctions pour les onglets des radars
            const visibleCamps = new Set();
            let originalMaxRange = 50; // Valeur par défaut, sera mise à jour au chargement

            // Attend que Plotly ait chargé le graphique initial
            document.addEventListener('DOMContentLoaded', function() {
                const radarDiv = document.getElementById('radarChart');
                
                // Récupérer la vraie échelle maximale utilisée au départ (moyenne/médiane)
                function updateOriginalScale() {
                    if (radarDiv.data && radarDiv.data.length >= 2) {
                        const means = radarDiv.data[0].r.slice(0, -1);
                        const medians = radarDiv.data[1].r.slice(0, -1);
                        const allValues = [...means, ...medians];
                        originalMaxRange = Math.max(...allValues) * 1.25;
                        if (originalMaxRange < 10) {
							originalMaxRange = 50; // sécurité
						}
                    }
                }

                // Observer les changements du graphique Plotly
                radarDiv.on('plotly_relayout', updateOriginalScale);
                radarDiv.on('plotly_afterplot', updateOriginalScale);

                // Au premier rendu
                setTimeout(updateOriginalScale, 500);
            });

            // Fonction pour recalculer la meilleure échelle selon les données visibles
            function updateRadarScale() {
                const div = document.getElementById('radarChart');
                if (!div.data || div.data.length === 0) return;

                let maxVal = 0;
                div.data.forEach(trace => {
                    if (trace.r && trace.visible !== 'legendonly') {
                        const traceMax = Math.max(...trace.r.slice(0, -1));
                        if (traceMax > maxVal) maxVal = traceMax;
                    }
                });

                const newRange = maxVal === 0 ? originalMaxRange : maxVal * 1.25;
                const finalRange = Math.max(newRange, 5); // jamais trop petit

                Plotly.relayout('radarChart', {
                    'polar.radialaxis.range': [0, finalRange]
                });
            }

            const colors = ['#1f77b4', '#ff7f0e', '#2ca02c', '#d62728', '#9467bd', '#8c564b', '#e377c2', '#7f7f7f', '#bcbd22', '#17becf'];

            window.toggleRadarForCamp = function(campId, campName) {
                const radarDiv = document.getElementById('radarChart');
                if (!radarDiv.data) return;
                const radarDiv2 = document.getElementById('radarChart2');
                if (!radarDiv2.data) return;
                
                const traceIndex = radarDiv.data.findIndex(t => t.name === campName);
                const traceIndex2 = radarDiv2.data.findIndex(t => t.name === campName);

                if (traceIndex === -1) {
                    // === AJOUTER LE CAMP ===
                    fetch(`/get_camp_data/${campId}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.error && data.info) {
                                alert(data.info);
                                return;
                            }
                            const notes = [...data.notes, data.notes[0]];
                            const dist = [...data.distances, data.distances[0]];
                            const cat = [...data.categories, data.categories[0]];
                            const color = colors[visibleCamps.size % colors.length];

                            Plotly.addTraces('radarChart', [{
                                type: 'scatterpolar',
                                r: dist,
                                theta: cat,
                                fill: 'toself',
                                name: data.nom,
                                line: { color: color, width: 2 }, // Trait plus fin
                                //  fillcolor: color.replace(')', ', 0.2)').replace('rgb', 'rgba'), // Remplissage plus transparent
                                opacity: 0.6
                            }]);
                            
                            Plotly.addTraces('radarChart2', [{
                                type: 'scatterpolar',
                                r: notes,
                                theta: cat,
                                fill: 'toself',
                                name: data.nom,
                                line: { color: color, width: 2 }, // Trait plus fin
                                //  fillcolor: color.replace(')', ', 0.2)').replace('rgb', 'rgba'), // Remplissage plus transparent
                                opacity: 0.6
                            }]);

                            visibleCamps.add(data.nom);
                            updateRadarScale();

                            // Info camp
                            document.getElementById('campName').textContent = data.nom;
                            document.getElementById('campDetails').textContent = `{{ _('camp_type') }}: ${data.type} | {{ _('camp_classification') }}: ${data.zone} | {{ _('camp_actif') }}: ${data.actif} `;
                            document.getElementById('campInfo').style.display = 'block';

                            // Changer le bouton en "Masquer"
                            setTimeout(() => {
                                const btn = document.querySelector(`button[onclick="window.parent.toggleRadarForCamp(${campId}, '${campName.replace(/'/g, "\\'")}')"]`);
                                if (btn) {
                                    btn.textContent = `{{ _('remove_from_radar') }}` ;
                                    btn.style.background = "#991b1b";
                                }
                            }, 100);
                        });
                } else {
                    // === SUPPRIMER LE CAMP ===
                    Plotly.deleteTraces('radarChart', traceIndex);
                    Plotly.deleteTraces('radarChart2', traceIndex2);

                    visibleCamps.delete(campName);
                    updateRadarScale();

                    // Remettre le bouton en "Voir"
                    setTimeout(() => {
                        const btn = document.querySelector(`button[onclick="window.parent.toggleRadarForCamp(${campId}, '${campName.replace(/'/g, "\\'")}')"]`);
                        if (btn) {
                            btn.textContent = `{{ _('add_to_radar') }}`;
                            btn.style.background = "#16a34a";
                        }
                    }, 100);

                    // Cacher l'info si plus rien
                    if (visibleCamps.size === 0) {
                        document.getElementById('campInfo').style.display = 'none';
                    }
                }
            };

            // === BOUTON VIDER TOUT ===
            function clearAllIndividualCamps() {
                const radarDiv = document.getElementById('radarChart');
                if ( radarDiv.data && radarDiv.data.length > 2) {
                    // Supprimer tous les tracés sauf les 2 premiers (moyenne + médiane)
                    const tracesToRemove = [];
                    for (let i = radarDiv.data.length - 1; i >= 2; i--) {
                        tracesToRemove.push(i);
                    }
                    Plotly.deleteTraces('radarChart', tracesToRemove);
                }
                const radarDiv2 = document.getElementById('radarChart2');
                if ( radarDiv.data && radarDiv.data.length > 1) {
                    // Supprimer tous les tracés sauf le premier ( médiane)
                    const tracesToRemove2 = [];
                    for (let i = radarDiv2.data.length - 1; i >= 1; i--) {
                        tracesToRemove2.push(i);
                    }
                    Plotly.deleteTraces('radarChart2', tracesToRemove2);
                }

                visibleCamps.clear();
                document.getElementById('campInfo').style.display = 'none';

                // Remettre l'échelle d'origine (calculée automatiquement)
                Plotly.relayout('radarChart', {
                    'polar.radialaxis.range': [0, 5]
                });
                Plotly.relayout('radarChart2', {
                    'polar.radialaxis.range': [0, 5]
                });

                // Réinitialiser tous les boutons
                document.querySelectorAll('button[onclick*="toggleRadarForCamp"]').forEach(btn => {
                    btn.textContent = `{{ _('add_to_radar') }}`;
                    btn.style.background = "#16a34a";
                });
            }

            // Option bonus : mise à jour automatique toutes les 300ms après un changement (fluidité)
            
            let updateTimeout;
            document.getElementById('radarChart').on('plotly_restyle', () => {
                clearTimeout(updateTimeout);
                updateTimeout = setTimeout(updateRadarScale, 300);
            });
           

            // Modal functions
            function showAboutModal() {
                document.getElementById('aboutModal').style.display = 'block';
            }
            function closeAboutModal() {
                document.getElementById('aboutModal').style.display = 'none';
            }
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('aboutModal');
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }
            
            // Onglets des radars
            function showTab(tabId) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                if(tabId==='tab1'){
                    document.querySelector('.tab-btn:nth-child(1)').classList.add('active');
                }else{
                    document.querySelector('.tab-btn:nth-child(2)').classList.add('active');
                }
                document.getElementById(tabId).classList.add('active');
            }
            // Onglets principaux
            function showTabGeneral(tabId) {
                document.querySelectorAll('.tab-btn2').forEach(btn => btn.classList.remove('active'));
                //document.querySelectorAll('.tab-content2').forEach(tab => tab.classList.remove('active'));
                if(tabId==='tab1_graphics'){
                    document.getElementById('aboutModal').classList.remove('active');
                    document.querySelector('.tab-btn2:nth-child(1)').classList.add('active');
                }else{
                    document.getElementById('tab1_graphics').classList.remove('active');
                    document.querySelector('.tab-btn2:nth-child(2)').classList.add('active');
                }
                document.getElementById(tabId).classList.add('active');
            }
        </script>
    </body>
    </html>
   